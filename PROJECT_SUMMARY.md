# DRVN - Garage Management System
## Complete Project Summary for AI/Developer Handoff

---

## Overview

**DRVN** is a PWA (Progressive Web App) for garage/car service center management, designed in Hebrew (RTL) and runs on:
- Browser (PWA)
- Android app via Median.co

**Current Version:** v2.2.0-new-onesignal

**Working Directory:** `C:/Users/h_26_/Desktop/garage-v2`

---

## Tech Stack

### Frontend
- **HTML/CSS/JavaScript** - Single file `public/index.html` (~368KB)
- **Firebase SDK** - Authentication & Database
- **OneSignal SDK** - Push Notifications
- **Median.co** - PWA to Android wrapper

### Backend
- **Firebase Hosting** - Web hosting
- **Firebase Cloud Functions** - Backend functions (Node.js)
- **Firestore Database** - NoSQL database
- **OneSignal** - Push notification service

---

## Project Structure

```
garage-v2/
├── public/
│   ├── index.html              # Main app (all frontend code)
│   ├── firebase-messaging-sw.js
│   ├── OneSignalSDKWorker.js
│   └── manifest.json
├── functions/
│   ├── index.js                # Cloud Functions (reminders)
│   ├── package.json
│   └── package-lock.json
├── firebase.json               # Firebase config
├── .firebaserc                 # Project ID config
└── PROJECT_SUMMARY.md          # This file
```

---

## Credentials & IDs

### Firebase
```
Project ID: garage-17263
Web App URL: https://garage-17263.web.app
```

### OneSignal (New Account - Recently Created)
```javascript
const ONESIGNAL_APP_ID = '4e012ba3-f512-4afc-a3d2-3adf7fc9d6f1';
const ONESIGNAL_REST_API_KEY = 'os_v2_app_jyasxi7vcjfpzi6shlpx7sow6fnaayv5tg2ucwuz4yp63gkm36alwxb4mn7p54sauyvat4ghhwt4k64pvzzmjfopxkxzq23awtp5smy';
```

### Median.co (Android App)
```
Package: co.median.android.rddeawq
Legacy Mode: ENABLED (required for notifications)
```

---

## Firestore Database Collections

### 1. `users`
```javascript
{
  odId: "user_id",
  name: "User Name",
  email: "email@example.com",
  phone: "0501234567",
  role: "admin" | "employee" | "customer",
  oneSignalPlayerId: "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx", // For push notifications
  createdAt: Timestamp
}
```

### 2. `appointments`
```javascript
{
  odId: "appointment_id",
  userId: "user_id",                    // Links to users collection
  carId: "car_id",
  date: "2026-02-02",                   // Format: YYYY-MM-DD
  time: "14:30",                        // Format: HH:MM
  status: "scheduled" | "completed" | "cancelled",
  type: "בדיקה" | "טיפול" | "תיקון",    // Inspection | Service | Repair
  notes: "Notes",
  ownerName: "Car Owner Name",
  plateNumber: "12-345-67",
  phone: "0501234567",
  reminder: true,                       // Whether to send reminder
  createdAt: Timestamp
}
```

### 3. `cars`
```javascript
{
  odId: "car_id",
  userId: "owner_user_id",
  plateNumber: "12-345-67",
  manufacturer: "Toyota",
  model: "Corolla",
  year: "2020",
  color: "White",
  vin: "VIN_NUMBER",
  createdAt: Timestamp
}
```

### 4. `maintenance`
```javascript
{
  carId: "car_id",
  type: "Oil Change",
  description: "Description",
  cost: 500,
  date: Timestamp,
  nextServiceDate: Timestamp
}
```

### 5. `reminders` (Auto-generated by Cloud Functions)
```javascript
{
  appointmentId: "appointment_id",
  reminderType: "24h" | "1h",
  sentAt: Timestamp
}
```

---

## Cloud Functions (functions/index.js)

### 1. `checkAppointmentReminders` - Main Reminder Function
```javascript
// Runs every 60 minutes
// Checks appointments and sends reminders:
// - 24 hours before appointment (between 23-25 hours)
// - 1 hour before appointment (between 0.5-1.5 hours)

exports.checkAppointmentReminders = functions
    .runWith({ timeoutSeconds: 540, memory: '256MB' })
    .pubsub
    .schedule('every 60 minutes')
    .timeZone('Asia/Jerusalem')
    .onRun(async (context) => {
        // 1. Get scheduled appointments for today, tomorrow, day after
        // 2. For each appointment, calculate time difference
        // 3. If 23-25 hours away → send 24h reminder
        // 4. If 0.5-1.5 hours away → send 1h reminder
        // 5. Check reminder wasn't already sent
        // 6. Send notification via OneSignal
        // 7. Mark reminder as sent in 'reminders' collection
    });
```

### 2. `cleanupOldReminders`
```javascript
// Runs daily at 2 AM Israel time
// Deletes reminder records older than 30 days
```

### 3. `sendTestReminder` (HTTP Callable)
```javascript
// Manual test function
// Called from app to send test notification
// Requires authentication
```

### OneSignal API v2 Helper Function
```javascript
async function sendPushNotification(playerIds, title, message, data = {}) {
    const response = await fetch('https://api.onesignal.com/notifications', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Key ${ONESIGNAL_REST_API_KEY}`  // NOTE: "Key" not "Basic"
        },
        body: JSON.stringify({
            app_id: ONESIGNAL_APP_ID,
            include_subscription_ids: playerIds,  // NOTE: subscription_ids not player_ids
            headings: { "en": title, "he": title },
            contents: { "en": message, "he": message },
            data: data,
            priority: 10,
            android_sound: "default",
            ios_sound: "default"
        })
    });
    return await response.json();
}
```

---

## Push Notifications System

### How It Works
1. User logs in to the app
2. App calls `enableMedianPush()` which:
   - Calls `median.onesignal.register()`
   - Gets Player ID with retry mechanism (5 attempts, 2s delay)
   - Saves Player ID to user's Firestore document
3. Cloud Function runs every hour:
   - Queries upcoming appointments
   - Gets user's Player ID from Firestore
   - Sends notification via OneSignal API

### Key Code in index.html
```javascript
// OneSignal initialization (around line 25 and 7115)
const ONESIGNAL_APP_ID = '4e012ba3-f512-4afc-a3d2-3adf7fc9d6f1';

// Enable push with retry mechanism
async function enableMedianPush() {
    const maxRetries = 5;
    const retryDelay = 2000;

    for (let i = 0; i < maxRetries; i++) {
        try {
            await median.onesignal.register();
            const playerId = await getMedianPlayerIdWithRetry();
            if (playerId) {
                await savePlayerIdToFirestore(playerId);
                return true;
            }
        } catch (error) {
            await new Promise(r => setTimeout(r, retryDelay));
        }
    }
    return false;
}

// Auto-fix on login
async function autoFixPlayerIdIfNeeded() {
    // Checks if Player ID exists, if not, tries to get and save it
}
```

### Median.co Requirements
- **Legacy Mode MUST be enabled** in Median Dashboard
- Rebuild app after any OneSignal changes

---

## Deployment Commands

### Deploy Everything
```bash
cd C:/Users/h_26_/Desktop/garage-v2
firebase deploy
```

### Deploy Hosting Only
```bash
firebase deploy --only hosting
```

### Deploy Functions Only
```bash
firebase deploy --only functions
```

### Deploy Specific Function
```bash
firebase deploy --only functions:checkAppointmentReminders
```

### View Function Logs
```bash
firebase functions:log --project garage-17263
```

---

## Issues Fixed

### 1. Push Notifications Not Reaching Android
**Problem:** Median was using new SDK (User Model)
**Solution:** Enable Legacy Mode in Median Dashboard + rebuild app

### 2. OneSignal API Not Working
**Problem:** New REST API Key uses v2 format
**Solution:**
- Change endpoint from `/api/v1/notifications` to `https://api.onesignal.com/notifications`
- Change Authorization from `Basic ${key}` to `Key ${key}`
- Change `include_player_ids` to `include_subscription_ids`

### 3. Player ID Not Being Saved
**Problem:** Timing issue - Median SDK not ready
**Solution:** Added retry mechanism with 5 attempts and 2 second delays

---

## Pending Tasks

### 1. Google Play Store Publishing
**Issue:** Identity verification failed - address mismatch
**Details:**
- Developer account registered with Israel address
- Has German payment profile (DRVN) available
- Need to link developer account to German payment profile
- Or provide identity documents matching Israel address

### 2. Potential Future Improvements
- Employee notifications
- Reports and statistics
- Invoice system
- Google Calendar integration
- Multi-language support

---

## Important URLs

| Service | URL |
|---------|-----|
| Live App | https://garage-17263.web.app |
| Firebase Console | https://console.firebase.google.com/project/garage-17263 |
| Firestore | https://console.firebase.google.com/project/garage-17263/firestore |
| Functions | https://console.firebase.google.com/project/garage-17263/functions |
| Functions Logs | https://console.cloud.google.com/logs/query?project=garage-17263 |
| OneSignal | https://dashboard.onesignal.com |
| Google Play Console | https://play.google.com/console |

---

## File Locations

```
Development (use this):
C:/Users/h_26_/Desktop/garage-v2

Backup (don't modify):
C:/Users/h_26_/Desktop/garage-final
```

---

## Quick Reference

### To Test Notifications
1. Create appointment with future date (tomorrow or 1.5 hours from now)
2. Wait for Cloud Function to run (every hour)
3. Or temporarily change schedule to `every 5 minutes` for testing

### To Change Reminder Schedule (Testing)
```javascript
// In functions/index.js, change:
.schedule('every 60 minutes')
// To:
.schedule('every 5 minutes')
// Then deploy: firebase deploy --only functions:checkAppointmentReminders
// REMEMBER to change back after testing!
```

### To Check If Notifications Are Working
1. Go to Firebase Console > Functions > Logs
2. Look for `checkAppointmentReminders` entries
3. Check for "Found X scheduled appointments" and "Sent X reminders"

---

## Contact & Notes

- App language: Hebrew (RTL)
- Timezone: Asia/Jerusalem
- User for testing: hamada.farkad123@gmail.com
- Test Player ID: da863126-ecbb-4fe0-a390-8e769e63326d

---

*Last Updated: February 2026*
*This document contains everything needed to continue development.*
